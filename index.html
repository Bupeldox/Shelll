<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>


    <style>
        .appConfig {
            padding: 0.25rem 0.5rem;
        }
    </style>
    <div>
        <a href="AppEditor/index.html">New App / Editor</a>
    </div>

    <table id="appsList">

    </table>

    <div id="templates" style="display:none;">
        <table>
            <tr class="appConfig">
                <td>
                    <span class="name"></span>
                </td>
                <td>
                    <span class="date"></span>
                </td>
                <td>
                    <a class="edit">Edit</a>
                    <a class="run">Run</a>
                </td>
            </tr>
        </table>
    </div>
    </div>
    <script>
        class TemplatedHtml {
            constructor(templateClassName) {
                var templateElement = document.querySelector("#templates ." + templateClassName + ", " + "#templates table ." + templateClassName);
                this.element = templateElement.cloneNode(true);
            }
            getElement(elClassName) {
                return this.element.querySelector("." + elClassName);
            }
            setText(elClassName, content) {
                this.element.querySelector("." + elClassName).textContent = content;
            }
            setSelectListOptions(elClassName, values, selected) {
                var selectList = this.element.querySelector("." + elClassName);
                selectList.innerHTML = "";
                values.map(v => {
                    var optionElement = document.createElement("option");
                    if (v.hasOwnProperty("text")) {
                        optionElement.textContent = v.text;
                        optionElement.value = v.value;
                    } else {
                        optionElement.textContent = v;
                        optionElement.value = v;
                    }
                    if (optionElement.value == selected) {
                        optionElement.selected = "true";
                    }
                });
            }
            setValue(elClassName, value) {
                this.element.querySelector("." + elClassName).value = value;
            }
            destroy() {
                this.element.remove();
            }
        }

        document.addEventListener("readystatechange", () => {
            if (document.readyState != "complete") {
                return;
            }
            fetch("/inDir/AppConfigs").then(r => r.json()).then(dirs => {
                var appConfigElements = [];
                var canDone = false;
                var tryDone = () => {
                    if (!canDone) {
                        return
                    }
                    var thing = appConfigElements.filter(i => !i.loaded).length == 0;
                    if (!thing) {
                        return;
                    }
                    appConfigElements
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(i => {
                        document
                        .getElementById("appsList")
                        .append(i.th.element);
                    });
                };
                dirs.map(fileName => {
                    let el = new TemplatedHtml("appConfig");
                    let t = {
                        th: el,
                        date: false,
                        loaded: false
                    };
                    
                    appConfigElements.push(t);

                    el.getElement("edit").href = "AppEditor/index.html?o=" + fileName;
                    el.getElement("run").href = "AppRunner/shell.html?o=" + fileName;

                    fetch("User/AppConfigs/" + fileName).then(r => r.json()).then(d => {
                        el.setText("name", d.name);
                        if (d.createdDate) {
                            el.setText("date", new Date(d.createdDate).toLocaleString());
                        }
                        t.date = d.createdDate
                        t.loaded = true;
                        tryDone();
                    });
                });

                canDone = true;
                tryDone();

            });
        });
        function loadConfig(name) {

        }

    </script>



</body>

</html>